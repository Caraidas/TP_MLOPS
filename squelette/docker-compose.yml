version: "3.9"

services:

  # =========================
  # MLflow – Tracking serveur
  # =========================
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.14.3
    container_name: mlflow
    ports:
      - "5000:5000"
    command: >
      mlflow server
      --host 0.0.0.0
      --port 5000
    # TODO : ajouter un volume pour persister les données MLflow
    # volumes:
    #   - mlflow_data:/mlflow

  # =========================
  # Entraînement du modèle
  # =========================
  train:
    # TODO : compléter le build (chemin du Dockerfile)
    build: ./services/train
    container_name: train
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - DATA_DIR=/data/knowledge
      # TODO : utiliser les variables du fichier .env
    volumes:
      - ./geometrie/knowledge:/data/knowledge:ro
    depends_on:
      - mlflow
    # Ce service est lancé manuellement
    profiles:
      - train

  # =========================
  # API d’inférence
  # =========================
  api:
    build: ./services/api
    container_name: api
    ports:
      - "8000:8000"
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - MODEL_NAME=geometrie-model
    depends_on:
      - mlflow

  # =========================
  # Prometheus – Monitoring
  # =========================
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    depends_on:
      - api
  # =========================
  # Grafana – Visualisation
  # =========================
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus


# =========================
# Volumes (optionnel TP 4h)
# =========================
# volumes:
#   mlflow_data:
